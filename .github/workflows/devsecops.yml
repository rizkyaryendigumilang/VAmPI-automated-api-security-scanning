# --- 4. DYNAMIC ANALYSIS (OWASP ZAP) ---
      - name: Run ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.13.0
        with:
          target: 'http://localhost:5000'
          fail_action: false 
          token: ${{ secrets.GITHUB_TOKEN }}

      # --- 5. BACA HASIL SCAN KE VARIABLE ---
      - name: Prepare Scan Results for Email
        if: always()
        run: |
          # Ambil hasil ringkasan ZAP (jika ada file report yang terbuat)
          # Untuk contoh ini, kita buat ringkasan teks sederhana
          echo "HADOLINT_LOG=$(docker run --rm -v $(pwd):/root:ro hadolint/hadolint < Dockerfile | head -n 10)" >> $GITHUB_ENV
          echo "TRIVY_LOG=$(trivy fs --severity HIGH,CRITICAL . | grep -A 10 "Total")" >> $GITHUB_ENV

      # --- 6. KIRIM EMAIL DENGAN DETAIL SCAN ---
      - name: Send Full Audit Report
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "üõ°Ô∏è [DETAILED REPORT] Audit Keamanan Selesai"
          to: rizkyaryendigumilang@gmail.com
          from: DevSecOps Automation Bot
          body: |
            Halo Rizky, berikut adalah detail hasil scan otomatis:

            1. INFRASTRUCTURE SCAN (HADOLINT):
            ${{ env.HADOLINT_LOG }}

            2. DEPENDENCY SCAN (TRIVY):
            ${{ env.TRIVY_LOG }}

            3. DYNAMIC SCAN (OWASP ZAP):
            Status: Selesai. Silakan cek detail kerentanan pada link di bawah.

            DETAIL LOG LENGKAP:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
