name: DevSecOps-Final-Success

on:
  push:
    branches: [ "main", "master" ]

jobs:
  security-pipeline:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 1. LOG SCRIPT SH
      - name: Run Scan Otomatis Script
        run: |
          chmod +x scan_otomatis.sh
          ./scan_otomatis.sh > hasil_scan_lengkap.txt 2>&1 || true

      # 2. HADOLINT
      - name: Run Hadolint
        run: |
          docker run --rm -v $(pwd):/root:ro hadolint/hadolint < Dockerfile > hadolint-report.txt || true

      # 3. TRIVY
      - name: Run Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          trivy fs --severity HIGH,CRITICAL . > trivy-report.txt || true

      # 4. RUN VAmPI
      - name: Build and Run VAmPI
        run: |
          docker build -t vampi-app .
          docker run -d --name vampi-instance -p 5000:5000 vampi-app
          sleep 15

      # 5. ZAP SCAN (VERSI STABIL Tanpa Upload Artifact Otomatis)
      - name: Run ZAP Baseline Scan
        run: |
          # Kita jalankan docker ZAP manual agar bisa ambil output teksnya tanpa error artifact
          docker run --network="host" -t ghcr.io/zaproxy/zaproxy:stable zap-baseline.py -t http://localhost:5000 -g gen.conf -r zap-report.html > zap-log.txt || true

      # 6. KIRIM EMAIL (DENGAN 4 LAMPIRAN)
      - name: Send Email with All Attachments
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "üõ°Ô∏è [FINAL SUCCESS] Audit Security: ${{ github.repository }}"
          to: rizkyaryendigumilang@gmail.com
          from: DevSecOps Automation Bot
          body: |
            Halo Rizky,

            Audit selesai! Semua tool (Hadolint, Trivy, ZAP) telah berhasil dijalankan.
            Saya melampirkan SEMUA hasil scan di bawah ini agar kamu bisa langsung menganalisis celah keamanan.

            Lampiran:
            1. hasil_scan_lengkap.txt (Log Terminal Keseluruhan)
            2. hadolint-report.txt (Celah Dockerfile)
            3. trivy-report.txt (Celah Library)
            4. zap-log.txt (Celah Runtime/Pentest)

            Status: ${{ job.status }}
          attachments: hasil_scan_lengkap.txt,hadolint-report.txt,trivy-report.txt,zap-log.txt
