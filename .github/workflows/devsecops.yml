name: DevSecOps-Ultimate-Pipeline

on:
  push:
    branches: [ "main", "master" ]

jobs:
  security-audit:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --- 1. RUN STATIC SCANS (IaC, SCA, SAST) ---
      # Menjalankan script yang menghasilkan hadolint-report.txt, trivy-report.txt, dan semgrep-report.txt
      - name: Run Static Security Scans
        run: |
          chmod +x scan_otomatis.sh
          ./scan_otomatis.sh

      # --- 2. PREPARE APP & WAF FOR DAST ---
      # Menggunakan 'docker compose' (tanpa tanda hubung) untuk menghindari error command not found
      - name: Build and Run VAmPI with WAF
        run: |
          docker compose up -d --build
          sleep 30 

      # --- 3. SIMULATE ATTACK & EXTRACT WAF REPORT ---
      - name: Simulate Attack and Extract WAF Report
        run: |
          # Memicu WAF dengan payload SQLi
          curl -I "http://localhost/api/v1/users/vampi%27%20OR%201=1" || true
          # Ambil log dari container nginx-waf ke file report
          docker logs nginx-waf 2>&1 | grep "WAF SECURITY ALERT" > waf-report.txt || echo "No WAF alerts found in this session" > waf-report.txt

      # --- 4. DAST: OWASP ZAP (DYNAMIC PENTESTING) ---
      - name: Run OWASP ZAP Pentest
        run: |
          docker run --rm --network="host" -v $(pwd):/zap/wrk/:rw -t ghcr.io/zaproxy/zaproxy:stable zap-baseline.py \
            -t http://localhost \
            -r zap-report.html > zap-report.txt || true

      # --- 5. SEND COMPLETE REPORTS VIA EMAIL ---
      - name: Send Multi-Layer Security Reports
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ðŸ›¡ï¸ DevSecOps Scanning: ${{ github.repository }} [SUCCESS]"
          to: rizkyaryendigumilang@gmail.com
          from: DevSecOps Automation Bot
          body: |
            Halo Rizky,

            Pipeline Keamanan Otomatis telah selesai dijalankan. 
            Berikut adalah hasil Scanning keamanan berlapis (Layered Security):

            1. IaC Scan (Hadolint) -> Infrastructure Check
            2. SCA Scan (Trivy) -> Dependency Check
            3. SAST Scan (Semgrep) -> Source Code Check
            4. DAST Scan (OWASP ZAP) -> Runtime Pentesting
            5. WAF Logs -> Runtime Protection (Blocked Attacks)

            Status: ${{ job.status }}
          attachments: |
            hadolint-report.txt
            trivy-report.txt
            semgrep-report.txt
            zap-report.txt
            waf-report.txt
